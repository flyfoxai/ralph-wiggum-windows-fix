# Smart Ralph Loop - 需求规格说明书

## 文档信息
- **版本**: 1.0
- **创建日期**: 2026-01-23
- **项目**: Ralph Wiggum Plugin Enhancement
- **功能名称**: Smart Ralph Loop (智能任务循环)

---

## 1. 需求概述

### 1.1 背景
现有的 `/ralph-loop` 命令需要手动指定最大循环次数 (`--max-iterations`)，这要求用户预先估计任务完成所需的迭代次数。这种方式存在以下问题：
- 估计过少：任务未完成就停止
- 估计过多：浪费 API 调用和时间
- 无法处理复杂的多任务场景

### 1.2 目标
创建一个新的智能命令 `/ralph-smart`，能够：
1. 从指定的文本文件读取任务目标
2. 自动判断任务是否完成
3. 智能决策何时终止循环
4. 支持多任务顺序执行
5. 无需手动指定最大迭代次数

---

## 2. 功能需求

### 2.1 核心功能

#### F1: 任务文件读取
**描述**: 从指定的文本文件读取任务描述和目标

**输入**:
- 文件路径（相对或绝对路径）
- 文件格式：Markdown 或纯文本

**输出**:
- 解析后的任务列表
- 每个任务的完成标准

**示例文件格式**:
```markdown
# 项目任务清单

## 任务 1: 实现用户认证功能
**目标**: 创建完整的用户登录和注册系统
**完成标准**:
- [ ] 创建用户模型和数据库表
- [ ] 实现注册 API 端点
- [ ] 实现登录 API 端点
- [ ] 添加 JWT token 生成和验证
- [ ] 编写单元测试并通过

## 任务 2: 实现用户个人资料页面
**目标**: 用户可以查看和编辑个人信息
**完成标准**:
- [ ] 创建个人资料 API 端点
- [ ] 实现前端个人资料页面
- [ ] 添加头像上传功能
- [ ] 编写集成测试并通过
```

#### F2: 智能完成判断
**描述**: AI 自动判断任务是否完成，无需人工干预

**判断依据**:
1. **代码验证**:
   - 检查所需文件是否创建
   - 验证代码是否编译/运行成功
   - 检查测试是否通过

2. **功能验证**:
   - 对照任务描述检查功能实现
   - 验证完成标准中的检查项
   - 分析代码覆盖率和质量

3. **自我评估**:
   - AI 分析自己的输出
   - 检查是否有未解决的错误
   - 确认所有子任务都已完成

**输出**:
- 完成状态：`completed` | `in_progress` | `blocked`
- 完成度百分比：0-100%
- 未完成项列表
- 建议的下一步行动

#### F3: 自动循环控制
**描述**: 根据任务完成情况自动决定是否继续循环

**决策逻辑**:
```
IF 当前任务完成度 >= 100%:
    IF 还有下一个任务:
        切换到下一个任务
        继续循环
    ELSE:
        所有任务完成
        终止循环
ELSE IF 当前任务被阻塞:
    记录阻塞原因
    询问用户是否继续
ELSE IF 迭代次数 > 安全上限 (默认 50):
    警告可能陷入无限循环
    询问用户是否继续
ELSE:
    继续当前任务
    继续循环
```

**安全机制**:
- 最大迭代次数上限（可配置，默认 50）
- 检测循环停滞（连续 N 次迭代无进展）
- 检测重复错误（同一错误出现 N 次）

#### F4: 多任务顺序执行
**描述**: 支持在一个文件中定义多个任务，按顺序完成

**功能**:
- 解析任务文件中的多个任务
- 维护任务队列和当前任务指针
- 自动切换到下一个任务
- 跟踪每个任务的完成状态

**任务状态**:
- `pending`: 等待执行
- `in_progress`: 正在执行
- `completed`: 已完成
- `blocked`: 被阻塞
- `skipped`: 已跳过

#### F5: 进度跟踪和报告
**描述**: 实时显示任务进度和完成情况

**显示信息**:
- 当前任务编号和总任务数
- 当前任务完成度
- 已完成的子任务列表
- 当前迭代次数
- 预计剩余迭代次数（基于历史数据）

**报告格式**:
```
🔄 Smart Ralph - 任务进度
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 任务: 2/5 (实现用户个人资料页面)
📊 完成度: 75% (3/4 子任务完成)
🔁 迭代: 8 次
⏱️  用时: 12 分钟

✅ 已完成:
  • 创建个人资料 API 端点
  • 实现前端个人资料页面
  • 添加头像上传功能

⏳ 进行中:
  • 编写集成测试并通过

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 3. 命令接口设计

### 3.1 命令语法

```bash
/ralph-smart <任务文件路径> [选项]
```

### 3.2 参数说明

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| `<任务文件路径>` | string | 是 | - | 任务描述文件的路径 |
| `--max-iterations` | number | 否 | 50 | 安全上限，防止无限循环 |
| `--auto-approve` | boolean | 否 | false | 自动批准任务切换，不询问用户 |
| `--strict-mode` | boolean | 否 | false | 严格模式，要求 100% 完成才算完成 |
| `--completion-threshold` | number | 否 | 90 | 完成度阈值（百分比），达到即视为完成 |
| `--stall-detection` | number | 否 | 5 | 连续 N 次无进展视为停滞 |
| `--verbose` | boolean | 否 | false | 显示详细的判断过程 |

### 3.3 使用示例

**示例 1: 基本使用**
```bash
/ralph-smart tasks.md
```

**示例 2: 自定义参数**
```bash
/ralph-smart project-plan.md --max-iterations 100 --completion-threshold 95
```

**示例 3: 自动模式**
```bash
/ralph-smart sprint-tasks.md --auto-approve --strict-mode
```

---

## 4. 技术实现方案

### 4.1 文件结构

```
ralph-wiggum/
├── commands/
│   ├── ralph-loop.md              # 现有命令
│   └── ralph-smart.md             # 新命令（入口）
├── scripts/
│   ├── setup-ralph-loop.sh        # 现有脚本
│   ├── setup-ralph-loop.ps1       # 现有脚本
│   ├── setup-ralph-smart.sh       # 新脚本（Bash）
│   └── setup-ralph-smart.ps1      # 新脚本（PowerShell）
├── hooks/
│   ├── stop-hook.sh               # 现有 hook
│   ├── stop-hook.ps1              # 现有 hook
│   ├── smart-stop-hook.sh         # 新 hook（Bash）
│   └── smart-stop-hook.ps1        # 新 hook（PowerShell）
└── lib/
    ├── task-parser.sh             # 任务文件解析器（Bash）
    ├── task-parser.ps1            # 任务文件解析器（PowerShell）
    ├── completion-checker.sh      # 完成度检查器（Bash）
    └── completion-checker.ps1     # 完成度检查器（PowerShell）
```

### 4.2 状态文件格式

**文件**: `.claude/ralph-smart.local.md`

```yaml
---
active: true
task_file: "tasks.md"
current_task_index: 1
total_tasks: 5
iteration: 8
max_iterations: 50
started_at: "2026-01-23T12:00:00Z"
auto_approve: false
strict_mode: false
completion_threshold: 90
stall_detection: 5
stall_count: 0
last_completion_percentage: 75
tasks:
  - id: 1
    title: "实现用户认证功能"
    status: "completed"
    completion: 100
    iterations: 12
  - id: 2
    title: "实现用户个人资料页面"
    status: "in_progress"
    completion: 75
    iterations: 8
  - id: 3
    title: "实现消息通知系统"
    status: "pending"
    completion: 0
    iterations: 0
---

## 当前任务: 实现用户个人资料页面

**目标**: 用户可以查看和编辑个人信息

**完成标准**:
- [x] 创建个人资料 API 端点
- [x] 实现前端个人资料页面
- [x] 添加头像上传功能
- [ ] 编写集成测试并通过

**当前进度**: 75% (3/4 完成)

**下一步行动**: 编写并运行集成测试
```

### 4.3 智能判断实现

#### 方案 A: 基于规则的判断（初期实现）
```bash
# 检查点：
1. 文件存在性检查
   - 检查任务描述中提到的文件是否创建

2. 代码执行检查
   - 运行构建命令（如 npm run build）
   - 运行测试命令（如 npm test）
   - 检查退出码

3. 检查清单验证
   - 解析 Markdown 中的 [ ] 和 [x]
   - 计算完成百分比

4. 错误检测
   - 检查是否有未解决的错误消息
   - 检查是否有 TODO/FIXME 注释
```

#### 方案 B: AI 自我评估（高级实现）
```bash
# 在每次迭代结束时，向 AI 提问：
"请评估当前任务的完成情况：
1. 任务目标：[从任务文件读取]
2. 完成标准：[从任务文件读取]
3. 你在本次迭代中完成的工作：[从 transcript 提取]

请以 JSON 格式回答：
{
  "completed": true/false,
  "completion_percentage": 0-100,
  "completed_items": ["item1", "item2"],
  "pending_items": ["item3"],
  "blocked_items": [],
  "confidence": 0-100,
  "reasoning": "解释为什么认为已完成或未完成",
  "next_action": "建议的下一步"
}

请在 <completion-assessment> 标签中输出 JSON。"
```

### 4.4 Stop Hook 增强

**smart-stop-hook.ps1** 需要实现：

1. **读取任务状态**
   - 解析 `.claude/ralph-smart.local.md`
   - 获取当前任务和完成标准

2. **提取 AI 的完成评估**
   - 从 transcript 中查找 `<completion-assessment>` 标签
   - 解析 JSON 格式的评估结果

3. **决策逻辑**
   ```powershell
   if ($assessment.completed -eq $true -and $assessment.confidence -ge 80) {
       if ($currentTaskIndex -lt $totalTasks) {
           # 切换到下一个任务
           $nextTaskIndex = $currentTaskIndex + 1
           Update-StateFile -NextTask $nextTaskIndex
           $prompt = Get-TaskPrompt -TaskIndex $nextTaskIndex
           Block-Stop -Reason $prompt
       } else {
           # 所有任务完成
           Write-Host "✅ 所有任务已完成！"
           Allow-Stop
       }
   } elseif ($iteration -ge $maxIterations) {
       # 达到最大迭代次数
       Write-Host "⚠️ 达到最大迭代次数 ($maxIterations)"
       Allow-Stop
   } elseif ($stallCount -ge $stallDetection) {
       # 检测到停滞
       Write-Host "⚠️ 检测到进度停滞"
       Allow-Stop
   } else {
       # 继续当前任务
       Block-Stop -Reason $currentTaskPrompt
   }
   ```

4. **进度更新**
   - 更新迭代计数
   - 更新完成度
   - 检测停滞情况

---

## 5. 任务文件格式规范

### 5.1 支持的格式

#### 格式 1: Markdown 检查清单（推荐）
```markdown
# 项目开发任务

## 任务 1: 实现用户认证
**描述**: 创建完整的用户登录和注册系统

**完成标准**:
- [ ] 创建 User 模型
- [ ] 实现注册 API
- [ ] 实现登录 API
- [ ] 添加 JWT 验证
- [ ] 测试通过

## 任务 2: 实现个人资料
**描述**: 用户可以查看和编辑个人信息

**完成标准**:
- [ ] 创建个人资料 API
- [ ] 实现前端页面
- [ ] 测试通过
```

#### 格式 2: YAML 格式
```yaml
tasks:
  - id: 1
    title: "实现用户认证"
    description: "创建完整的用户登录和注册系统"
    acceptance_criteria:
      - "创建 User 模型"
      - "实现注册 API"
      - "实现登录 API"
      - "添加 JWT 验证"
      - "测试通过"

  - id: 2
    title: "实现个人资料"
    description: "用户可以查看和编辑个人信息"
    acceptance_criteria:
      - "创建个人资料 API"
      - "实现前端页面"
      - "测试通过"
```

#### 格式 3: 简单文本格式
```
任务 1: 实现用户认证
- 创建 User 模型
- 实现注册 API
- 实现登录 API
- 添加 JWT 验证
- 测试通过

任务 2: 实现个人资料
- 创建个人资料 API
- 实现前端页面
- 测试通过
```

### 5.2 解析规则

1. **任务识别**:
   - Markdown: `## 任务 N:` 或 `## Task N:`
   - YAML: `tasks[].title`
   - 文本: `任务 N:` 或 `Task N:`

2. **完成标准识别**:
   - Markdown: `- [ ]` 或 `- [x]` 列表
   - YAML: `acceptance_criteria[]`
   - 文本: 缩进的 `-` 列表

3. **完成状态**:
   - `[ ]`: 未完成
   - `[x]`: 已完成
   - 完成度 = 已完成项 / 总项数 × 100%

---

## 6. 用户交互设计

### 6.1 启动时
```
🚀 Smart Ralph 启动
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 任务文件: tasks.md
📋 总任务数: 5
🎯 完成阈值: 90%
🔁 最大迭代: 50
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

开始执行任务 1/5: 实现用户认证功能
```

### 6.2 迭代过程中
```
🔄 迭代 8 | 任务 2/5 | 完成度 75%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 已完成: 创建个人资料 API 端点
✅ 已完成: 实现前端个人资料页面
✅ 已完成: 添加头像上传功能
⏳ 进行中: 编写集成测试并通过
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 6.3 任务完成时
```
✅ 任务 2 完成！(实现用户个人资料页面)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 统计:
  • 迭代次数: 12
  • 用时: 18 分钟
  • 完成度: 100%

🎯 切换到下一个任务...

开始执行任务 3/5: 实现消息通知系统
```

### 6.4 全部完成时
```
🎉 所有任务已完成！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 总体统计:
  • 总任务数: 5
  • 总迭代次数: 47
  • 总用时: 1 小时 23 分钟
  • 平均每任务: 9.4 次迭代

✅ 已完成任务:
  1. 实现用户认证功能 (12 次迭代)
  2. 实现用户个人资料页面 (12 次迭代)
  3. 实现消息通知系统 (8 次迭代)
  4. 实现搜索功能 (10 次迭代)
  5. 实现数据导出功能 (5 次迭代)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 6.5 异常情况
```
⚠️ 检测到进度停滞
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
连续 5 次迭代完成度未变化 (75%)

可能原因:
  • 遇到技术难题
  • 缺少必要的依赖或信息
  • 任务定义不清晰

建议操作:
  1. 检查错误日志
  2. 更新任务描述
  3. 手动介入解决

是否继续尝试? (y/n)
```

---

## 7. 非功能需求

### 7.1 性能要求
- 任务文件解析时间 < 1 秒
- 状态文件读写时间 < 100ms
- 完成度判断时间 < 2 秒

### 7.2 兼容性要求
- 支持 Windows 10/11 (PowerShell 7+)
- 支持 macOS (Bash 4+)
- 支持 Linux (Bash 4+)
- 与现有 `/ralph-loop` 命令共存

### 7.3 可靠性要求
- 状态文件损坏时能够恢复
- 异常退出后能够恢复执行
- 防止无限循环（最大迭代次数保护）

### 7.4 可维护性要求
- 代码模块化，易于扩展
- 详细的日志记录
- 清晰的错误消息

---

## 8. 测试计划

### 8.1 单元测试
- [ ] 任务文件解析器测试
- [ ] 完成度计算测试
- [ ] 状态文件读写测试
- [ ] 停滞检测测试

### 8.2 集成测试
- [ ] 单任务完整流程测试
- [ ] 多任务顺序执行测试
- [ ] 任务切换测试
- [ ] 异常恢复测试

### 8.3 端到端测试
- [ ] 真实项目开发场景测试
- [ ] 不同任务文件格式测试
- [ ] 跨平台兼容性测试

### 8.4 边界测试
- [ ] 空任务文件
- [ ] 单任务文件
- [ ] 大量任务（100+）
- [ ] 达到最大迭代次数
- [ ] 任务文件格式错误

---

## 9. 实施计划

### 阶段 1: 基础实现（MVP）
**目标**: 实现核心功能，支持单任务自动完成判断

**交付物**:
- [ ] 任务文件解析器（Markdown 格式）
- [ ] 基本的完成度判断（基于检查清单）
- [ ] smart-stop-hook 实现
- [ ] `/ralph-smart` 命令入口

**时间**: 预计 2-3 天

### 阶段 2: 多任务支持
**目标**: 支持多任务顺序执行和任务切换

**交付物**:
- [ ] 任务队列管理
- [ ] 任务切换逻辑
- [ ] 进度跟踪和显示
- [ ] 状态持久化

**时间**: 预计 1-2 天

### 阶段 3: 智能判断增强
**目标**: 实现 AI 自我评估和高级判断

**交付物**:
- [ ] AI 自我评估提示词
- [ ] 评估结果解析
- [ ] 停滞检测
- [ ] 置信度计算

**时间**: 预计 2-3 天

### 阶段 4: 完善和优化
**目标**: 完善用户体验和错误处理

**交付物**:
- [ ] 详细的进度报告
- [ ] 异常恢复机制
- [ ] 用户交互优化
- [ ] 文档和示例

**时间**: 预计 1-2 天

---

## 10. 风险和挑战

### 10.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| AI 判断不准确 | 高 | 中 | 使用多种判断方法结合，设置置信度阈值 |
| 任务文件解析复杂 | 中 | 中 | 先支持简单格式，逐步扩展 |
| 状态管理复杂 | 中 | 低 | 使用成熟的状态文件格式（YAML frontmatter） |
| 跨平台兼容性 | 中 | 低 | 同时维护 Bash 和 PowerShell 版本 |

### 10.2 用户体验风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 任务定义不清晰 | 高 | 高 | 提供详细的任务文件模板和示例 |
| 误判任务完成 | 高 | 中 | 设置完成阈值，允许用户调整 |
| 无限循环 | 高 | 低 | 强制最大迭代次数限制 |
| 学习曲线陡峭 | 中 | 中 | 提供详细文档和教程 |

---

## 11. 成功标准

### 11.1 功能完整性
- ✅ 支持从文件读取任务
- ✅ 自动判断任务完成
- ✅ 支持多任务顺序执行
- ✅ 智能循环控制
- ✅ 详细的进度报告

### 11.2 性能指标
- ✅ 判断准确率 > 85%
- ✅ 平均减少 30% 的迭代次数（相比固定次数）
- ✅ 任务切换延迟 < 2 秒

### 11.3 用户满意度
- ✅ 用户能够快速上手（< 10 分钟）
- ✅ 减少手动干预需求
- ✅ 提高开发效率

---

## 12. 附录

### 12.1 术语表

| 术语 | 定义 |
|------|------|
| Ralph Loop | 基于 Stop Hook 的自引用循环技术 |
| Smart Ralph | 增强版 Ralph Loop，支持智能判断和多任务 |
| 完成度 | 任务完成的百分比，基于完成标准计算 |
| 停滞 | 连续多次迭代完成度无变化 |
| 置信度 | AI 对判断结果的信心程度（0-100%） |

### 12.2 参考资料
- [Ralph Wiggum 技术原理](https://ghuntley.com/ralph/)
- [Claude Code 插件开发文档](https://github.com/anthropics/claude-code)
- [Stop Hook API 文档](https://github.com/anthropics/claude-code/blob/main/docs/hooks.md)

### 12.3 示例任务文件
参见 `examples/` 目录：
- `simple-task.md` - 单任务示例
- `multi-task.md` - 多任务示例
- `complex-project.md` - 复杂项目示例

---

## 文档变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0 | 2026-01-23 | Claude | 初始版本 |

---

**文档状态**: ✅ 已完成
**审核状态**: ⏳ 待审核
**批准状态**: ⏳ 待批准
